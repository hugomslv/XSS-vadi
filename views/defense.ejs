<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - XSS VADI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="alert alert-success mb-0 text-center" role="alert">
    <strong>üõ°Ô∏è SECTION D√âFENSE :</strong> Apprenez √† prot√©ger vos applications contre les attaques XSS
  </div>

  <main class="container my-5">
    <h1 class="mb-4">üõ°Ô∏è D√©fenses contre les attaques XSS</h1>

    <div class="alert alert-info">
      <h5>Objectif de cette section</h5>
      <p class="mb-0">
        Maintenant que vous avez vu comment fonctionnent les attaques XSS, il est crucial de comprendre
        comment s'en prot√©ger. Voici les principales techniques de d√©fense.
      </p>
    </div>

    <!-- 1. √âchappement -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">1. √âchappement (Escaping)</h4>
      </div>
      <div class="card-body">
        <h5>Principe</h5>
        <p>
          L'√©chappement consiste √† convertir les caract√®res sp√©ciaux HTML en entit√©s HTML afin qu'ils
          soient affich√©s comme du texte plut√¥t que d'√™tre interpr√©t√©s comme du code.
        </p>

        <h5>Conversions</h5>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Caract√®re</th>
              <th>Entit√© HTML</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>&lt;</code></td>
              <td><code>&amp;lt;</code></td>
              <td>Ouvre une balise HTML</td>
            </tr>
            <tr>
              <td><code>&gt;</code></td>
              <td><code>&amp;gt;</code></td>
              <td>Ferme une balise HTML</td>
            </tr>
            <tr>
              <td><code>&amp;</code></td>
              <td><code>&amp;amp;</code></td>
              <td>Caract√®re d'√©chappement</td>
            </tr>
            <tr>
              <td><code>"</code></td>
              <td><code>&amp;quot;</code></td>
              <td>Guillemet double</td>
            </tr>
            <tr>
              <td><code>'</code></td>
              <td><code>&amp;#x27;</code></td>
              <td>Apostrophe</td>
            </tr>
          </tbody>
        </table>

        <h5>Exemple de code</h5>
        <pre><code>// JavaScript (c√¥t√© client)
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// EJS (c√¥t√© serveur)
// Utiliser <%= %> au lieu de <%- %>
&lt;%= userInput %&gt;  // SAFE : √©chappe le HTML
&lt;%- userInput %&gt;  // UNSAFE : rend le HTML tel quel</code></pre>
      </div>
    </div>

    <!-- 2. Sanitization -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0">2. Sanitization (Assainissement)</h4>
      </div>
      <div class="card-body">
        <h5>Principe</h5>
        <p>
          La sanitization permet d'autoriser certaines balises HTML (comme <code>&lt;strong&gt;</code>, <code>&lt;em&gt;</code>)
          tout en supprimant les √©l√©ments dangereux (scripts, √©v√©nements, iframes, etc.).
        </p>

        <h5>Biblioth√®ques recommand√©es</h5>
        <ul>
          <li><strong>DOMPurify</strong> (c√¥t√© client) : <a href="https://github.com/cure53/DOMPurify" target="_blank">https://github.com/cure53/DOMPurify</a></li>
          <li><strong>sanitize-html</strong> (c√¥t√© serveur) : <a href="https://github.com/apostrophecms/sanitize-html" target="_blank">https://github.com/apostrophecms/sanitize-html</a></li>
        </ul>

        <h5>Exemple avec DOMPurify</h5>
        <pre><code>// Inclure DOMPurify
&lt;script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"&gt;&lt;/script&gt;

// Utilisation
const dirty = '&lt;img src=x onerror=alert(1)&gt; &lt;b&gt;Texte en gras&lt;/b&gt;';
const clean = DOMPurify.sanitize(dirty);
// R√©sultat : '&lt;img src="x"&gt; &lt;b&gt;Texte en gras&lt;/b&gt;'
// Le onerror a √©t√© supprim√© !</code></pre>

        <h5>Exemple avec sanitize-html (Node.js)</h5>
        <pre><code>const sanitizeHtml = require('sanitize-html');

const dirty = '&lt;script&gt;alert("XSS")&lt;/script&gt;&lt;p&gt;Hello&lt;/p&gt;';
const clean = sanitizeHtml(dirty, {
  allowedTags: ['p', 'b', 'i', 'em', 'strong'],
  allowedAttributes: {}
});
// R√©sultat : '&lt;p&gt;Hello&lt;/p&gt;'</code></pre>
      </div>
    </div>

    <!-- 3. Content Security Policy -->
    <div class="card mb-4">
      <div class="card-header bg-warning">
        <h4 class="mb-0">3. Content Security Policy (CSP)</h4>
      </div>
      <div class="card-body">
        <h5>Principe</h5>
        <p>
          CSP est un en-t√™te HTTP qui permet de d√©finir les sources autoris√©es pour le chargement
          de scripts, styles, images, etc. Cela emp√™che l'ex√©cution de scripts inline malveillants.
        </p>

        <h5>Exemple de configuration</h5>
        <pre><code>// Express.js
app.use((req, res, next) => {
  res.setHeader(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'"
  );
  next();
});</code></pre>

        <h5>Directives principales</h5>
        <ul>
          <li><code>default-src 'self'</code> : Autorise uniquement les ressources du m√™me domaine</li>
          <li><code>script-src 'self'</code> : Autorise les scripts uniquement du m√™me domaine</li>
          <li><code>script-src 'nonce-{random}'</code> : Autorise uniquement les scripts avec un nonce sp√©cifique</li>
          <li><code>script-src 'unsafe-inline'</code> : ‚ö†Ô∏è √Ä √©viter ! Autorise les scripts inline</li>
        </ul>
      </div>
    </div>

    <!-- 4. Cookies HttpOnly -->
    <div class="card mb-4">
      <div class="card-header bg-danger text-white">
        <h4 class="mb-0">4. Cookies HttpOnly et Secure</h4>
      </div>
      <div class="card-body">
        <h5>Principe</h5>
        <p>
          Les cookies marqu√©s <code>HttpOnly</code> ne sont pas accessibles via JavaScript (<code>document.cookie</code>),
          ce qui prot√®ge contre le vol de session via XSS.
        </p>

        <h5>Exemple</h5>
        <pre><code>// Express.js
res.cookie('sessionId', 'abc123', {
  httpOnly: true,  // Emp√™che l'acc√®s via JavaScript
  secure: true,    // Envoie uniquement via HTTPS
  sameSite: 'strict' // Protection contre CSRF
});</code></pre>

        <h5>‚ö†Ô∏è Note sur cette d√©mo</h5>
        <p class="alert alert-warning">
          Dans cette application de d√©monstration, les cookies sont volontairement configur√©s avec
          <code>httpOnly: false</code> pour permettre la d√©monstration de l'exfiltration.
          <strong>En production, TOUJOURS utiliser httpOnly: true pour les cookies sensibles !</strong>
        </p>
      </div>
    </div>

    <!-- 5. Validation des entr√©es -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h4 class="mb-0">5. Validation et filtrage des entr√©es</h4>
      </div>
      <div class="card-body">
        <h5>Principe</h5>
        <p>
          Valider et filtrer toutes les entr√©es utilisateur c√¥t√© serveur. Ne jamais faire confiance
          aux donn√©es provenant du client.
        </p>

        <h5>Bonnes pratiques</h5>
        <ul>
          <li>Valider le type de donn√©es (nombre, email, URL, etc.)</li>
          <li>Limiter la longueur des cha√Ænes</li>
          <li>Utiliser des listes blanches (whitelist) plut√¥t que des listes noires</li>
          <li>Rejeter les entr√©es suspectes au lieu d'essayer de les "nettoyer"</li>
        </ul>

        <h5>Exemple</h5>
        <pre><code>// Validation avec express-validator
const { body, validationResult } = require('express-validator');

app.post('/comment',
  body('content').isLength({ min: 1, max: 500 }).trim().escape(),
  (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    // Traitement...
  }
);</code></pre>
      </div>
    </div>

    <!-- R√©sum√© -->
    <div class="card border-success">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0">‚úÖ Checklist de s√©curit√©</h4>
      </div>
      <div class="card-body">
        <ul class="mb-0">
          <li>‚úÖ Toujours √©chapper les entr√©es utilisateur avant affichage</li>
          <li>‚úÖ Utiliser des biblioth√®ques de sanitization pour le HTML riche</li>
          <li>‚úÖ Impl√©menter une Content Security Policy stricte</li>
          <li>‚úÖ Marquer les cookies sensibles comme HttpOnly et Secure</li>
          <li>‚úÖ Valider toutes les entr√©es c√¥t√© serveur</li>
          <li>‚úÖ Utiliser des frameworks modernes qui √©chappent par d√©faut (React, Vue, Angular)</li>
          <li>‚úÖ Former les d√©veloppeurs aux risques XSS</li>
          <li>‚úÖ Effectuer des audits de s√©curit√© r√©guliers</li>
        </ul>
      </div>
    </div>

    <div class="mt-4 text-center">
      <a href="/chapters" class="btn btn-primary">Retour aux chapitres</a>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
