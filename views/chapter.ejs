<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - XSS VADI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <% const currentPage = 'chapters'; %>
  <%- include('partials/navbar') %>

  <!-- Banner d'avertissement -->
  <div class="alert alert-warning alert-banner">
    <span class="alert-icon">&#9888;</span>
    <div class="alert-content">
      <p class="alert-message"><strong>AVERTISSEMENT :</strong> Application VOLONTAIREMENT VULNERABLE - Usage pedagogique uniquement</p>
    </div>
  </div>

  <main class="container py-xl">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <span class="breadcrumb-item"><a href="/chapters">Chapitres</a></span>
      <span class="breadcrumb-separator">&#8250;</span>
      <span class="breadcrumb-item active"><%= chapter.title %></span>
    </nav>

    <div class="flex items-center justify-between mb-lg">
      <h1><%= chapter.title %></h1>
      <span id="refreshIndicator" class="badge badge-success" style="cursor: pointer;" onclick="toggleAutoRefresh()" title="Rafraichissement auto active">
        &#128260; Auto
      </span>
    </div>

    <!-- Objectif du chapitre -->
    <div class="chapter-objective">
      <span class="chapter-objective-icon">&#127919;</span>
      <div>
        <strong class="text-primary">Objectif :</strong>
        <span class="text-secondary"><%= chapter.instructions %></span>
      </div>
    </div>

    <!-- Contenu du cours -->
    <div class="card card-primary mb-lg">
      <div class="card-header">
        <h4>&#128214; Contenu du cours</h4>
      </div>
      <div class="card-body">
        <%- chapter.content %>
      </div>
    </div>

    <!-- Zone de test XSS -->
    <div class="card card-warning mb-lg">
      <div class="card-header">
        <h4>&#129514; Zone de test</h4>
      </div>
      <div class="card-body">
        <form method="POST" action="/chapter/<%= chapter.id %>/post" id="postForm">
          <div class="form-group">
            <label for="content" class="form-label">Message a poster :</label>
            <textarea
              class="form-textarea"
              id="content"
              name="content"
              rows="4"
              required
              placeholder="Essayez d'injecter du HTML ou JavaScript ici..."
            ></textarea>
            <span class="form-hint">
              Exemples : <code>&lt;strong&gt;gras&lt;/strong&gt;</code> ou <code>&lt;script&gt;alert('XSS')&lt;/script&gt;</code>
            </span>
          </div>

          <!-- Toggle Safe/Unsafe -->
          <div class="xss-mode-toggle">
            <label class="form-switch">
              <input type="checkbox" class="form-switch-input" id="safeMode" name="safe" value="true">
              <span class="form-switch-slider"></span>
              <span class="form-switch-label">Mode SAFE</span>
            </label>
            <div id="modeIndicator" class="xss-mode-indicator unsafe">
              &#9888; UNSAFE - Le HTML/JS sera execute
            </div>
          </div>

          <p class="text-sm text-secondary mb-md">
            <strong>Mode SAFE :</strong> Le contenu est echappe (affiche comme texte).<br>
            <strong>Mode UNSAFE :</strong> Le contenu est rendu tel quel (vulnerable).
          </p>

          <button type="submit" class="btn btn-warning">
            &#128228; Poster le message
          </button>
        </form>
      </div>
    </div>

    <!-- Messages postes -->
    <div class="card mb-lg" id="postsCard">
      <div class="card-header">
        <h4>&#128172; Messages postes (<span id="postCount"><%= posts.length %></span>)</h4>
      </div>
      <div class="card-body" id="postsContainer">
        <% if (posts.length === 0) { %>
          <p class="text-muted text-center py-lg">Aucun message pour le moment. Soyez le premier a poster !</p>
        <% } else { %>
          <% posts.forEach(post => { %>
            <div class="xss-post <%= post.safe ? 'safe' : 'unsafe' %>">
              <div class="xss-post-header">
                <div class="xss-post-author">
                  &#128100; <%= post.author %>
                  <span class="badge <%= post.safe ? 'badge-safe' : 'badge-unsafe' %>">
                    <%= post.safe ? 'SAFE' : 'UNSAFE' %>
                  </span>
                </div>
                <span class="xss-post-time"><%= new Date(post.timestamp).toLocaleString('fr-FR') %></span>
              </div>
              <div class="xss-post-content">
                <% if (post.safe) { %>
                  <%= post.content %>
                <% } else { %>
                  <div class="alert alert-danger mb-md">
                    <span class="alert-icon">&#9888;</span>
                    <div class="alert-content">
                      <p class="alert-message text-sm">Rendu UNSAFE : Le contenu ci-dessous est rendu tel quel (HTML/JS non echappe)</p>
                    </div>
                  </div>
                  <%- post.content %>
                <% } %>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <!-- Commentaires admin globaux -->
    <% if (globalComments.length > 0) { %>
      <div class="card card-primary mb-lg" id="globalCommentsCard">
        <div class="card-header">
          <h4>&#128227; Annonces de l'administrateur</h4>
        </div>
        <div class="card-body" id="globalCommentsContainer">
          <% globalComments.forEach(comment => { %>
            <div class="alert alert-info mb-md">
              <div class="alert-content">
                <div class="flex justify-between items-center mb-sm">
                  <strong>&#128100; Administrateur</strong>
                  <span class="text-xs text-muted"><%= new Date(comment.timestamp).toLocaleString('fr-FR') %></span>
                </div>
                <!-- ATTENTION : Rendu non echappe pour demonstration -->
                <div class="mt-sm">
                  <%- comment.content %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>

    <!-- Section commentaires -->
    <div class="card">
      <div class="card-header">
        <h4>&#128173; Commentaires (<span id="commentCount"><%= comments.length %></span>)</h4>
      </div>
      <div class="card-body">
        <form method="POST" action="/chapter/<%= chapter.id %>/comment" class="mb-lg">
          <div class="form-group">
            <label for="commentContent" class="form-label">Ajouter un commentaire :</label>
            <textarea
              class="form-textarea"
              id="commentContent"
              name="content"
              rows="2"
              required
              placeholder="Votre commentaire..."
            ></textarea>
          </div>
          <button type="submit" class="btn btn-success">
            &#128172; Commenter
          </button>
        </form>

        <hr>

        <div id="commentsContainer">
          <% if (comments.length === 0) { %>
            <p class="text-muted text-center">Aucun commentaire pour le moment.</p>
          <% } else { %>
            <% comments.forEach(comment => { %>
              <div class="card mb-md">
                <div class="card-body">
                  <div class="flex justify-between items-center mb-sm">
                    <span class="text-sm">&#128100; <%= comment.author %></span>
                    <span class="text-xs text-muted"><%= new Date(comment.timestamp).toLocaleString('fr-FR') %></span>
                  </div>
                  <p class="mb-0"><%= comment.content %></p>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between mt-xl">
      <a href="/chapters" class="btn">&#8592; Retour aux chapitres</a>
      <a href="/demo" class="btn btn-primary">Demo interactive &#8594;</a>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="/js/app.js"></script>
  <script>
    // Toggle safe mode indicator
    const safeMode = document.getElementById('safeMode');
    const modeIndicator = document.getElementById('modeIndicator');

    safeMode.addEventListener('change', function() {
      if (this.checked) {
        modeIndicator.className = 'xss-mode-indicator safe';
        modeIndicator.innerHTML = '&#10003; SAFE - Le HTML/JS sera echappe';
      } else {
        modeIndicator.className = 'xss-mode-indicator unsafe';
        modeIndicator.innerHTML = '&#9888; UNSAFE - Le HTML/JS sera execute';
      }
    });

    // Auto-refresh functionality
    const CHAPTER_ID = '<%= chapter.id %>';
    let currentCounts = {
      posts: <%= posts.length %>,
      comments: <%= comments.length %>,
      globalComments: <%= globalComments.length %>
    };
    let autoRefreshEnabled = true;
    let refreshInterval = null;

    async function refreshChapterData() {
      if (!autoRefreshEnabled) return;

      try {
        const response = await fetch(`/api/chapter/${CHAPTER_ID}`);
        const data = await response.json();

        if (data.success) {
          if (data.counts.posts !== currentCounts.posts ||
              data.counts.comments !== currentCounts.comments ||
              data.counts.globalComments !== currentCounts.globalComments) {
            ToastManager.info('Nouveau contenu disponible ! Rechargement...', 2000);
            setTimeout(() => location.reload(), 2000);
          }
        }
      } catch (error) {
        console.error('Erreur rafraichissement:', error);
      }
    }

    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const indicator = document.getElementById('refreshIndicator');

      if (autoRefreshEnabled) {
        indicator.className = 'badge badge-success';
        indicator.innerHTML = '&#128260; Auto';
        indicator.title = 'Rafraichissement auto active';
        startAutoRefresh();
      } else {
        indicator.className = 'badge';
        indicator.innerHTML = '&#9208; Pause';
        indicator.title = 'Rafraichissement auto en pause';
        stopAutoRefresh();
      }
    }

    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(refreshChapterData, 5000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Start auto-refresh
    startAutoRefresh();
    window.addEventListener('beforeunload', stopAutoRefresh);
  </script>
</body>
</html>
