<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - XSS VADI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="alert alert-primary mb-0 text-center" role="alert">
    <strong>üë®‚Äçüíº PANNEAU ADMINISTRATEUR</strong> - Gestion des commentaires globaux et visualisation des captures
  </div>

  <main class="container my-5">
    <h1 class="mb-4">üë®‚Äçüíº Panneau Administrateur</h1>

    <!-- Commentaires globaux -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">üì¢ Commentaires globaux (affich√©s sur tous les chapitres)</h4>
      </div>
      <div class="card-body">
        <form method="POST" action="/admin/global-comment" class="mb-4">
          <div class="mb-3">
            <label for="content" class="form-label">Contenu du commentaire :</label>
            <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
            <small class="form-text text-danger">
              ‚ö†Ô∏è Le contenu sera rendu tel quel (HTML non √©chapp√©) - utilisez avec pr√©caution !
            </small>
          </div>
          <button type="submit" class="btn btn-primary">Publier le commentaire global</button>
          <a href="/admin/demo-rickroll" class="btn btn-warning">
            üéµ D√©mo Rickroll + Exfiltration
          </a>
        </form>

        <hr>

        <h5>Commentaires actuels (<%= globalComments.length %>)</h5>
        <% if (globalComments.length === 0) { %>
          <p class="text-muted">Aucun commentaire global pour le moment.</p>
        <% } else { %>
          <% globalComments.forEach(comment => { %>
            <div class="card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <small class="text-muted">
                    <%= new Date(comment.timestamp).toLocaleString('fr-FR') %>
                  </small>
                  <form method="POST" action="/admin/global-comment/delete/<%= comment.id %>" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger">Supprimer</button>
                  </form>
                </div>
                <!-- Affichage √©chapp√© pour √©viter l'ex√©cution dans le panneau admin -->
                <div class="border p-2 bg-light">
                  <small class="text-muted mb-2 d-block"><strong>‚ö†Ô∏è Aper√ßu (non ex√©cut√©) :</strong></small>
                  <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;"><code><%= comment.content %></code></pre>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>

    <!-- Captures (demoToken) -->
    <div class="card mb-4">
      <div class="card-header bg-danger text-white">
        <h4 class="mb-0">üéØ Captures de demoToken (<%= captures.length %>)</h4>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <p class="mb-0">
            Ces captures repr√©sentent les <strong>demoToken</strong> exfiltr√©s via des payloads XSS.
            En situation r√©elle, cela pourrait √™tre des cookies de session.
          </p>
          <% if (captures.length > 0) { %>
            <form method="POST" action="/admin/captures/clear">
              <button type="submit" class="btn btn-warning">Vider les captures</button>
            </form>
          <% } %>
        </div>

        <% if (captures.length === 0) { %>
          <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Aucune capture pour le moment.</strong>
            <p class="mb-0">
              Pour tester l'exfiltration, utilisez un payload XSS dans un chapitre (par exemple le Chapitre 4)
              ou utilisez le bouton "D√©mo Rickroll" ci-dessus.
            </p>
          </div>
        <% } else { %>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Date/Heure</th>
                  <th>Type</th>
                  <th>DemoToken</th>
                  <th>Utilisateur</th>
                  <th>üîê Mot de passe</th>
                  <th>Chapitre</th>
                  <th>User-Agent</th>
                </tr>
              </thead>
              <tbody>
                <% captures.forEach(capture => { %>
                  <tr class="<%= capture.password ? 'table-danger' : '' %>">
                    <td><%= new Date(capture.timestamp).toLocaleString('fr-FR') %></td>
                    <td>
                      <% if (capture.captureType === 'form') { %>
                        <span class="badge bg-danger">Formulaire</span>
                      <% } else { %>
                        <span class="badge bg-warning text-dark">Cookie</span>
                      <% } %>
                    </td>
                    <td><code><%= capture.demoToken %></code></td>
                    <td><strong><%= capture.userName || 'Unknown' %></strong></td>
                    <td>
                      <% if (capture.password) { %>
                        <span class="badge bg-danger" style="font-size: 0.9rem;">
                          üîì <%= capture.password %>
                        </span>
                      <% } else { %>
                        <span class="text-muted">-</span>
                      <% } %>
                    </td>
                    <td><%= capture.chapterId || 'N/A' %></td>
                    <td class="small"><%= capture.userAgent ? capture.userAgent.substring(0, 50) + '...' : 'N/A' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Statistiques -->
    <div class="card">
      <div class="card-header bg-info text-white">
        <h4 class="mb-0">üìä Statistiques</h4>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h2 class="text-primary"><%= chapters.length %></h2>
                <p class="mb-0">Chapitres</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h2 class="text-warning"><%= globalComments.length %></h2>
                <p class="mb-0">Commentaires globaux</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-light">
              <div class="card-body text-center">
                <h2 class="text-danger"><%= captures.length %></h2>
                <p class="mb-0">Captures</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Rafra√Æchissement automatique des captures
    let currentCaptureCount = <%= captures.length %>;
    let autoRefreshEnabled = true;
    let refreshInterval = null;

    // Fonction pour rafra√Æchir les captures
    async function refreshCaptures() {
      if (!autoRefreshEnabled) return;

      try {
        const response = await fetch('/admin/api/captures');
        const data = await response.json();

        if (data.success) {
          // V√©rifier s'il y a de nouvelles captures
          if (data.count !== currentCaptureCount) {
            const hasNewCaptures = data.count > currentCaptureCount;
            currentCaptureCount = data.count;

            // Mettre √† jour le DOM
            updateCapturesTable(data.captures, hasNewCaptures);

            // Notification visuelle si nouvelles captures
            if (hasNewCaptures) {
              showNewCaptureNotification(data.count);
              // Animation flash sur le header
              const capturesCard = document.querySelector('.card-header.bg-danger');
              if (capturesCard) {
                capturesCard.classList.add('flash-animation');
                setTimeout(() => capturesCard.classList.remove('flash-animation'), 1000);
              }
            }
          }
        }
      } catch (error) {
        console.error('Erreur lors du rafra√Æchissement des captures:', error);
      }
    }

    // Mettre √† jour le tableau des captures
    function updateCapturesTable(captures, highlight = false) {
      const captureCountBadge = document.querySelector('.card-header.bg-danger h4');
      if (captureCountBadge) {
        captureCountBadge.innerHTML = `üéØ Captures de demoToken (<span class="capture-count">${captures.length}</span>)`;
      }

      // Mettre √† jour le compteur dans les stats
      const statsCount = document.querySelectorAll('.card.bg-light h2')[2];
      if (statsCount) {
        statsCount.textContent = captures.length;
        if (highlight) {
          statsCount.classList.add('text-success');
          setTimeout(() => statsCount.classList.remove('text-success'), 2000);
        }
      }

      const cardBody = document.querySelector('.card-header.bg-danger').parentElement.querySelector('.card-body');

      if (captures.length === 0) {
        cardBody.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="mb-0">
              Ces captures repr√©sentent les <strong>demoToken</strong> exfiltr√©s via des payloads XSS.
              En situation r√©elle, cela pourrait √™tre des cookies de session.
            </p>
          </div>
          <div class="alert alert-info">
            <strong>‚ÑπÔ∏è Aucune capture pour le moment.</strong>
            <p class="mb-0">
              Pour tester l'exfiltration, utilisez un payload XSS dans un chapitre (par exemple le Chapitre 4)
              ou utilisez le bouton "D√©mo Rickroll" ci-dessus.
            </p>
          </div>
        `;
      } else {
        let tableHTML = `
          <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="mb-0">
              Ces captures repr√©sentent les <strong>demoToken</strong> exfiltr√©s via des payloads XSS.
              En situation r√©elle, cela pourrait √™tre des cookies de session.
            </p>
            <form method="POST" action="/admin/captures/clear">
              <button type="submit" class="btn btn-warning">Vider les captures</button>
            </form>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Date/Heure</th>
                  <th>Type</th>
                  <th>DemoToken</th>
                  <th>Utilisateur</th>
                  <th>üîê Mot de passe</th>
                  <th>Chapitre</th>
                  <th>User-Agent</th>
                </tr>
              </thead>
              <tbody>
        `;

        captures.forEach((capture, index) => {
          let rowClass = (highlight && index === 0) ? 'table-success' : '';
          if (capture.password) rowClass += ' table-danger';

          const date = new Date(capture.timestamp).toLocaleString('fr-FR');
          const demoToken = capture.demoToken || 'N/A';
          const userName = capture.userName || 'Unknown';
          const chapterId = capture.chapterId || 'N/A';
          const userAgent = capture.userAgent ? capture.userAgent.substring(0, 50) + '...' : 'N/A';
          const captureType = capture.captureType === 'form' ? '<span class="badge bg-danger">Formulaire</span>' : '<span class="badge bg-warning text-dark">Cookie</span>';
          const password = capture.password ? `<span class="badge bg-danger" style="font-size: 0.9rem;">üîì ${capture.password}</span>` : '<span class="text-muted">-</span>';

          tableHTML += `
            <tr class="${rowClass}">
              <td>${date}</td>
              <td>${captureType}</td>
              <td><code>${demoToken}</code></td>
              <td><strong>${userName}</strong></td>
              <td>${password}</td>
              <td>${chapterId}</td>
              <td class="small">${userAgent}</td>
            </tr>
          `;
        });

        tableHTML += `
              </tbody>
            </table>
          </div>
        `;

        cardBody.innerHTML = tableHTML;
      }
    }

    // Afficher une notification de nouvelle capture
    function showNewCaptureNotification(count) {
      // Cr√©er une notification toast
      const notification = document.createElement('div');
      notification.className = 'toast-notification';
      notification.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 10000; min-width: 300px;">
          <strong>‚úÖ Nouvelle capture !</strong><br>
          Total: ${count} capture(s)
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      document.body.appendChild(notification);

      // Retirer apr√®s 5 secondes
      setTimeout(() => {
        notification.remove();
      }, 5000);

      // Son de notification (optionnel)
      playNotificationSound();
    }

    // Jouer un son de notification (optionnel)
    function playNotificationSound() {
      // Utiliser l'API Web Audio pour un petit "beep"
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (e) {
        // Ignore si l'API Audio n'est pas disponible
      }
    }

    // Toggle auto-refresh
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById('toggleRefreshBtn');

      if (autoRefreshEnabled) {
        btn.textContent = '‚è∏Ô∏è Pause';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
        startAutoRefresh();
      } else {
        btn.textContent = '‚ñ∂Ô∏è Reprendre';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        stopAutoRefresh();
      }
    }

    // D√©marrer le rafra√Æchissement automatique
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(refreshCaptures, 3000); // Toutes les 3 secondes
    }

    // Arr√™ter le rafra√Æchissement automatique
    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Ajouter le bouton de toggle au header des captures
    document.addEventListener('DOMContentLoaded', function() {
      const capturesHeader = document.querySelector('.card-header.bg-danger');
      if (capturesHeader) {
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'toggleRefreshBtn';
        toggleBtn.className = 'btn btn-sm btn-warning float-end';
        toggleBtn.textContent = '‚è∏Ô∏è Pause';
        toggleBtn.onclick = toggleAutoRefresh;

        const h4 = capturesHeader.querySelector('h4');
        h4.appendChild(toggleBtn);
      }

      // D√©marrer le rafra√Æchissement automatique
      startAutoRefresh();
    });

    // Arr√™ter le rafra√Æchissement quand l'utilisateur quitte la page
    window.addEventListener('beforeunload', stopAutoRefresh);
  </script>

  <style>
    @keyframes flash {
      0%, 100% { background-color: #dc3545; }
      50% { background-color: #28a745; }
    }

    .flash-animation {
      animation: flash 0.5s ease-in-out 2;
    }

    .toast-notification {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .capture-count {
      font-weight: bold;
    }
  </style>
</body>
</html>
